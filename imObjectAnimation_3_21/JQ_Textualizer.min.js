(function($,window){"use strict";function getStyle(element){var computedStyle,key,camelCasedStyle,i,len,styleList={};if(window.getComputedStyle)if(computedStyle=window.getComputedStyle(element,null),computedStyle.length)for(i=0,len=computedStyle.length;i<len;i++)camelCasedStyle=computedStyle[i].replace(/\-([a-z])/,function(a,b){return b.toUpperCase()}),styleList[camelCasedStyle]=computedStyle.getPropertyValue(computedStyle[i]);else for(key in computedStyle)typeof computedStyle[key]!="function"&&key!=="length"&&(styleList[key]=computedStyle[key]);else{computedStyle=element.currentStyle||element.style;for(key in computedStyle)Object.prototype.hasOwnProperty.call(computedStyle,key)&&(styleList[key]=computedStyle[key])}return styleList}function Character(){this.character=null;this.domNode=null;this.pos=null;this.used=!1;this.inserted=!1;this.visited=!1}function Snippet(){this.str="";this.characterList=[]}var Textualizer,COMMON_CHARACTER_ARRANGE_DELAY=1e3,REMAINING_CHARACTERS_DELAY=500,EFFECT_DURATION=2e3,REMAINING_CHARACTERS_APPEARANCE_MAX_DELAY=2e3,REMOVE_CHARACTERS_MAX_DELAY=2e3;Snippet.prototype={use:function(val){var ch=null;return $.each(this.characterList,function(){if(this.character===val&&!this.used)return this.used=!0,ch=this,!1}),ch},reset:function(){$.each(this.characterList,function(){this.inserted=!1;this.used=!1})}};Textualizer=function($element,data,options){function positionSnippet(snippet,phantomSnippets){var yOffset=options.centered?(elementHeight-$phantomContainer.height())/2:0;$.each(phantomSnippets,function(index,c){c.pos=c.domNode.position();c.domNode=c.domNode.clone();c.pos.top+=yOffset;c.domNode.css({left:c.pos.left,top:c.pos.top,position:"absolute"});snippet.characterList.push(c)});$phantomContainer.html("")}function addCharsToSnippet(i){var phantomSnippets=[],snippet=new Snippet,j,ch,c,len;for(snippet.str=list[i],snippets.push(snippet),j=0,len=snippet.str.length;j<len;j++)ch=snippet.str.charAt(j),ch===""?$phantomContainer.append(" "):(c=new Character,c.character=ch,c.domNode=$("<span/>").text(ch),$phantomContainer.append(c.domNode),phantomSnippets.push(c));return positionSnippet(snippet,phantomSnippets),snippet}function getHideEffect(){var dfd,eff;return eff=[function(target){return dfd=$.Deferred(),target.animate({top:position.bottom,opacity:"hide"},dfd.resolve),dfd.promise()},function(target){return dfd=$.Deferred(),target.fadeOut(1e3,dfd.resolve),dfd.promise()}],eff[Math.floor(Math.random()*eff.length)]}function removeCharacters(previousSnippet,currentSnippet){var keepList=[],removeList=[],finalDfd=$.Deferred(),hideEffect=getHideEffect(),currChar;return $.each(previousSnippet.characterList,function(index,prevChar){currChar=currentSnippet.use(prevChar.character);currChar?(currChar.domNode=prevChar.domNode,currChar.inserted=!0,keepList.push(currChar)):function(deferred){removeList.push(deferred);hideEffect(prevChar.domNode.delay(Math.random()*REMOVE_CHARACTERS_MAX_DELAY)).done(function(){prevChar.domNode.remove();deferred.resolve()})}($.Deferred())}),$.when.apply(null,removeList).done(function(){return finalDfd.resolve(keepList)}),finalDfd.promise()}function showCharacters(snippet){var effects=$.fn.textualizer.effects,effect=options.effect==="random"?effects[Math.floor(Math.random()*(effects.length-2))+1][1]:showCharEffect,finalDfd=$.Deferred(),animationDfdList=[];return $.each(snippet.characterList,function(index,ch){ch.inserted||(ch.domNode.css({left:ch.pos.left,top:ch.pos.top}),function(deferred){window.setTimeout(function(){effect({item:ch,container:$container,dfd:deferred})},Math.random()*REMAINING_CHARACTERS_APPEARANCE_MAX_DELAY);animationDfdList.push(deferred)}($.Deferred()))}),$.when.apply(null,animationDfdList).done(function(){finalDfd.resolve()}),finalDfd.promise()}function moveAndShowRemainingCharacters(characters,currentSnippet){var finalDfd=$.Deferred(),rearrangeDfdList=[];return window.setTimeout(function(){$.each(characters,function(index,item){(function(deferred){item.domNode.animate({left:item.pos.left,top:item.pos.top},options.rearrangeDuration,deferred.resolve);rearrangeDfdList.push(deferred.promise())})($.Deferred())});$.when.apply(null,rearrangeDfdList).done(function(){window.setTimeout(function(){showCharacters(currentSnippet).done(function(){finalDfd.resolve()})},REMAINING_CHARACTERS_DELAY)})},COMMON_CHARACTER_ARRANGE_DELAY),finalDfd.promise()}function rotater(){index===list.length-1&&($.each(snippets,function(j,snippet){snippet.reset()}),index=-1,options.loop||self.pause());index++;next(index)}function rotate(i){var dfd=$.Deferred(),current=snippets[i];return current||(current=addCharsToSnippet(i)),previous?removeCharacters(previous,current).done(function(characters){moveAndShowRemainingCharacters(characters,current).done(function(){dfd.resolve()})}):showCharacters(current).done(function(){dfd.resolve()}),previous=current,dfd.promise()}function next(i){paused||rotate(i).done(function(){$element.trigger("textualzer.blurbchanged",{index:i});window.setTimeout(rotater,options.duration)})}var self=this,list=[],snippets,index,previous,showCharEffect=null,playing=!1,paused=!1,elementHeight,position,$clone,$container,$phantomContainer;options.effect!=="random"&&$.each($.fn.textualizer.effects,function(){if(this[0]===options.effect)return showCharEffect=this[1],!1});$clone=$element.clone().removeAttr("id").appendTo(window.document.body);$clone.css(getStyle($element[0]));$clone.css({position:"absolute",top:"-1000px"});$phantomContainer=$("<div />").css({position:"relative",visibility:"hidden"}).appendTo($clone);$element.css("overflow","hidden");$container=$("<div />").css("position","relative").appendTo($element);elementHeight=$element.height();position={bottom:elementHeight};this.data=function(dataSource){this.stop();list=dataSource;snippets=[]};this.stop=function(){this.pause();playing=!1;previous=null;index=0;$container.empty();$phantomContainer.empty()};this.pause=function(){paused=!0;playing=!1};this.start=function(){list.length===0||playing||(index=index||0,playing=!0,paused=!1,next(index))};this.destroy=function(){$container.parent().removeData("textualizer").end().remove();$phantomContainer.remove()};data&&data instanceof Array&&this.data(data)};$.fn.textualizer=function(){var args=arguments,snippets,options,instance,txtlzr;return txtlzr=function($element){return instance=$element.data("textualizer"),instance||(snippets=[],args.length===1&&args[0]instanceof Array?snippets=args[0]:args.length===1&&typeof args[0]=="object"?options=args[0]:args.length===2&&(snippets=args[0],options=args[1]),snippets.length===0&&$element.find("p").each(function(){snippets.push($(this).text())}),$element.html(""),instance=new Textualizer($element,snippets,$.extend({},$.fn.textualizer.defaults,options)),$element.data("textualizer",instance)),instance}(this),typeof args[0]=="string"&&txtlzr[args[0]]&&txtlzr[args[0]].apply(txtlzr,Array.prototype.slice.call(args,1)),this};$.fn.textualizer.defaults={effect:"random",duration:2e3,rearrangeDuration:1e3,centered:!1,loop:!0};$.fn.textualizer.effects=[["none",function(obj){obj.container.append(obj.item.domNode.show())}],["fadeIn",function(obj){return obj.container.append(obj.item.domNode.fadeIn(EFFECT_DURATION,obj.dfd.resolve)),obj.dfd.promise()}],["slideLeft",function(obj){return obj.item.domNode.appendTo(obj.container).css({left:-1e3}).show().animate({left:obj.item.pos.left},EFFECT_DURATION,obj.dfd.resolve),obj.dfd.promise()}],["slideTop",function(obj){return obj.item.domNode.appendTo(obj.container).css({top:-1e3}).show().animate({top:obj.item.pos.top},EFFECT_DURATION,obj.dfd.resolve),obj.dfd.promise()}]]})(jQuery,window)